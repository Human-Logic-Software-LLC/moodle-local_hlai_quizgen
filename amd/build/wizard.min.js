// along with Moodle.  If not, see <https://www.gnu.org/licenses/>.
/**
 * AI Quiz Generator - Wizard Module
 *
 * Handles all wizard step interactions, form validation, and UI behaviour
 * across the 5-step quiz generation wizard. Replaces inline JavaScript
 * previously embedded in wizard.php.
 *
 * Initialized via:
 *   $PAGE->requires->js_call_amd('local_hlai_quizgen/wizard', 'init', [$jsconfig]);
 *
 * @module     local_hlai_quizgen/wizard
 * @copyright  2025 Human Logic Software LLC
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define(["jquery"],function($){"use strict";var Wizard={config:{},init:function(config){this.config=config;var step=String(config.step);switch(step){case"1":this.initStep1();break;case"3":this.initStep3();break;case"3.5":this.initStep3_5();break;case"4":this.initStep4();break;case"5":this.initStep5();break}},initStep1:function(){this._bindStep1FormSubmit();this._bindContentSourceToggles();this._bindFileInputChange();this._bindActivitySelectionControls()},_bindStep1FormSubmit:function(){var self=this;var form=document.getElementById("content-upload-form");if(!form){form=document.querySelector('form[enctype="multipart/form-data"]')}if(form){form.addEventListener("submit",function(e){if(!self._validateStep1Form()){e.preventDefault();return false}})}},_validateStep1Form:function(){var el;el=document.getElementById("source_manual");var manualChecked=el?el.checked:false;el=document.getElementById("source_upload");var uploadChecked=el?el.checked:false;el=document.getElementById("source_url");var urlChecked=el?el.checked:false;el=document.getElementById("source_activities");var activitiesChecked=el?el.checked:false;el=document.getElementById("source_scan_course");var scanCourseChecked=el?el.checked:false;el=document.getElementById("source_scan_resources");var scanResourcesChecked=el?el.checked:false;el=document.getElementById("source_scan_activities");var scanActivitiesChecked=el?el.checked:false;if(!manualChecked&&!uploadChecked&&!urlChecked&&!activitiesChecked&&!scanCourseChecked&&!scanResourcesChecked&&!scanActivitiesChecked){alert("Please select at least one content source!");return false}if(manualChecked){var manualTextEl=document.getElementById("manual_text");var manualText=manualTextEl?manualTextEl.value.trim():"";if(manualText===""){alert("Please enter some manual text or uncheck the Manual Entry option.");return false}}if(uploadChecked){var fileInput=document.getElementById("content-files");var files=fileInput?fileInput.files:[];if(files.length===0){alert("Please select files to upload or uncheck the Upload Files option.");return false}var maxFileSizeMB=50;var maxFileSizeBytes=maxFileSizeMB*1024*1024;var oversizedFiles=[];Array.from(files).forEach(function(file){if(file.size>maxFileSizeBytes){oversizedFiles.push(file.name+" ("+(file.size/1024/1024).toFixed(2)+" MB)")}});if(oversizedFiles.length>0){alert("The following files exceed the maximum size of "+maxFileSizeMB+" MB:\n\n"+oversizedFiles.join("\n")+"\n\nPlease remove these files and try again.");return false}}if(urlChecked){var urlListEl=document.getElementById("url_list");var urlList=urlListEl?urlListEl.value.trim():"";if(urlList===""){alert("Please enter at least one URL or uncheck the URL option.");return false}}if(activitiesChecked){var selectedActivities=document.querySelectorAll(".hlai-activity-checkbox:checked");if(selectedActivities.length===0){alert("Please select at least one activity or uncheck the Course Activities option.");return false}}return true},_bindContentSourceToggles:function(){var self=this;document.querySelectorAll(".content-source-checkbox[data-source]").forEach(function(cb){cb.addEventListener("change",function(){self._toggleContentSection(this.dataset.source)})})},_toggleContentSection:function(source){var checkbox=document.getElementById("source_"+source);var section=document.getElementById("section-"+source);if(section&&checkbox){section.style.display=checkbox.checked?"block":"none"}this._updateSelectedSources()},_updateSelectedSources:function(){var checkboxes=document.querySelectorAll(".content-source-checkbox:checked");var display=document.getElementById("selected-sources-display");var list=document.getElementById("selected-sources-list");if(checkboxes.length>0){var sources=[];checkboxes.forEach(function(cb){var label=document.querySelector('label[for="'+cb.id+'"] strong');if(label){sources.push(label.textContent)}});if(list){list.textContent=sources.join(" + ")}if(display){display.style.display="block"}}else{if(display){display.style.display="none"}}},_bindFileInputChange:function(){var self=this;var fileInput=document.getElementById("content-files");if(!fileInput){return}fileInput.addEventListener("change",function(e){var fileCount=e.target.files.length;var label=e.target.nextElementSibling;var fileList=document.getElementById("uploaded-files-list");var maxFileSizeMB=50;var maxFileSizeBytes=maxFileSizeMB*1024*1024;var hasOversizedFiles=false;var oversizedFileNames=[];if(fileCount>0){if(label){label.innerText=fileCount+" file(s) selected"}var fileNames='<div class="mt-2"><strong>Selected files:</strong><ul class="mb-0">';Array.from(e.target.files).forEach(function(file){var safeEl=document.createElement("div");safeEl.textContent=file.name;var safeFileName=safeEl.innerHTML;var fileSizeMB=(file.size/1024/1024).toFixed(2);var sizeClass=file.size>maxFileSizeBytes?"text-danger":"text-muted";if(file.size>maxFileSizeBytes){hasOversizedFiles=true;oversizedFileNames.push(file.name+" ("+fileSizeMB+" MB)");fileNames+='<li class="text-danger">'+safeFileName+' <span class="'+sizeClass+'">('+fileSizeMB+" MB) - TOO LARGE!</span></li>"}else{fileNames+="<li>"+safeFileName+' <span class="'+sizeClass+'">('+fileSizeMB+" MB)</span></li>"}});fileNames+="</ul></div>";if(hasOversizedFiles){fileNames+='<div class="notification is-danger is-light mt-2"><strong>Error:</strong> '+"The following files exceed the maximum size of "+maxFileSizeMB+" MB:<ul>";oversizedFileNames.forEach(function(fname){fileNames+="<li>"+fname+"</li>"});fileNames+="</ul>Please remove these files before submitting.</div>"}if(fileList){fileList.innerHTML=fileNames}}else{var chooseFilesText=self.config.strings&&self.config.strings.choose_files?self.config.strings.choose_files:"Choose files...";if(label){label.innerText=chooseFilesText}if(fileList){fileList.innerHTML=""}}})},_bindActivitySelectionControls:function(){var self=this;var selectAllBtn=document.getElementById("select-all-activities");if(selectAllBtn){selectAllBtn.addEventListener("click",function(){document.querySelectorAll(".hlai-activity-checkbox").forEach(function(cb){cb.checked=true});self._updateActivityCount()})}var deselectAllBtn=document.getElementById("deselect-all-activities");if(deselectAllBtn){deselectAllBtn.addEventListener("click",function(){document.querySelectorAll(".hlai-activity-checkbox").forEach(function(cb){cb.checked=false});self._updateActivityCount()})}document.querySelectorAll(".hlai-activity-checkbox").forEach(function(cb){cb.addEventListener("change",function(){self._updateActivityCount()})});this._updateActivityCount()},_updateActivityCount:function(){var checked=document.querySelectorAll(".hlai-activity-checkbox:checked").length;var countDisplay=document.getElementById("selected-activities-count");var selectedBar=document.querySelector(".hlai-activities-selected-bar");if(countDisplay){var text=checked===1?"1 activity selected":checked+" activities selected";countDisplay.textContent=text}if(selectedBar){if(checked>0){selectedBar.classList.add("has-selection")}else{selectedBar.classList.remove("has-selection")}}document.querySelectorAll(".hlai-activity-checkbox").forEach(function(cb){var card=cb.closest(".hlai-activity-card");if(card){if(cb.checked){card.classList.add("is-selected")}else{card.classList.remove("is-selected")}}})},initStep3:function(){this._bindDifficultyButtons();this._bindBloomsSliders();this._bindQuestionTypeDistribution();this._bindStep3FormSubmit()},_bindDifficultyButtons:function(){document.querySelectorAll('.hlai-diff-btn input[type="radio"]').forEach(function(radio){radio.addEventListener("change",function(){document.querySelectorAll(".hlai-diff-btn").forEach(function(btn){btn.classList.remove("is-active")});if(this.parentElement){this.parentElement.classList.add("is-active")}})})},_bindBloomsSliders:function(){var self=this;document.querySelectorAll('input[type="range"][id^="blooms_"]').forEach(function(slider){self._updateSliderColor(slider);slider.addEventListener("input",function(){self._updateSliderColor(this);self._updateBloomsTotal()})});this._updateBloomsTotal()},_updateSliderColor:function(slider){var value=slider.value;var id=slider.id;var color=slider.dataset.color||"#6366f1";var valueEl=document.getElementById(id+"_value");if(valueEl){valueEl.textContent=value+"%"}slider.style.background="linear-gradient(to right, "+color+" 0%, "+color+" "+value+"%, #e2e8f0 "+value+"%, #e2e8f0 100%)"},_updateBloomsTotal:function(){var levels=["remember","understand","apply","analyze","evaluate","create"];var total=0;levels.forEach(function(level){var slider=document.getElementById("blooms_"+level);if(slider){total+=parseInt(slider.value,10)}});var totalElem=document.getElementById("blooms_total");if(totalElem){totalElem.textContent=total+"%";if(total===100){totalElem.style.color="#10b981"}else if(total>80&&total<120){totalElem.style.color="#f59e0b"}else{totalElem.style.color="#ef4444"}}},_bindQuestionTypeDistribution:function(){var self=this;var totalInput=document.getElementById("total-questions");if(totalInput){totalInput.addEventListener("input",function(){self._updateQuestionTypeDistribution()})}document.querySelectorAll(".hlai-qtype-input").forEach(function(input){input.addEventListener("input",function(){self._updateQuestionTypeTotal()})});this._updateQuestionTypeTotal()},_updateQuestionTypeDistribution:function(){var totalInput=document.getElementById("total-questions");var total=totalInput?parseInt(totalInput.value,10)||10:10;var displayEl=document.getElementById("qtype-total-display");if(displayEl){var parts=displayEl.textContent.split("/");displayEl.textContent=(parts[0]?parts[0].trim():"0")+" / "+total}document.querySelectorAll(".hlai-qtype-input").forEach(function(input){input.max=total});this._updateQuestionTypeTotal()},_updateQuestionTypeTotal:function(){var totalInput=document.getElementById("total-questions");var totalRequired=totalInput?parseInt(totalInput.value,10)||10:10;var total=0;document.querySelectorAll(".hlai-qtype-input").forEach(function(input){var val=parseInt(input.value,10)||0;total+=val;if(val>0){input.classList.add("has-value")}else{input.classList.remove("has-value")}});var displayEl=document.getElementById("qtype-total-display");if(displayEl){displayEl.textContent=total+" / "+totalRequired;displayEl.classList.remove("is-valid","is-warning","is-error");if(total===totalRequired){displayEl.classList.add("is-valid")}else if(total>totalRequired){displayEl.classList.add("is-error")}else{displayEl.classList.add("is-warning")}}},_bindStep3FormSubmit:function(){var configForm=document.getElementById("question-config-form");var generateBtn=document.getElementById("generate-btn");var loadingOverlay=document.getElementById("loading-overlay");var totalInput=document.getElementById("total-questions");var isSubmitting=false;if(configForm){configForm.addEventListener("submit",function(e){var totalRequired=totalInput?parseInt(totalInput.value,10)||10:10;var total=0;document.querySelectorAll(".hlai-qtype-input").forEach(function(input){total+=parseInt(input.value,10)||0});if(total===0){e.preventDefault();alert("Please specify at least one question type with a quantity greater than 0.");return false}if(total!==totalRequired){e.preventDefault();alert("Question type total ("+total+") must equal total questions ("+totalRequired+").");return false}if(isSubmitting){e.preventDefault();return false}isSubmitting=true;if(loadingOverlay){loadingOverlay.style.display="flex"}if(generateBtn){generateBtn.disabled=true;generateBtn.textContent="Generating..."}})}},initStep3_5:function(){var refreshUrl=this.config.refreshUrl;if(refreshUrl){setTimeout(function(){window.location.href=refreshUrl},2e3)}},initStep4:function(){this._bindSelectAllQuestions();this._bindBulkAction();this._bindQuestionFilters()},_bindSelectAllQuestions:function(){var selectAll=document.getElementById("select-all-questions");if(selectAll){selectAll.addEventListener("change",function(){var checked=this.checked;document.querySelectorAll(".question-checkbox").forEach(function(checkbox){var card=checkbox.closest(".question-card");if(card&&card.style.display!=="none"){checkbox.checked=checked}})})}},_bindBulkAction:function(){var bulkBtn=document.getElementById("bulk-action-btn");if(!bulkBtn){return}bulkBtn.addEventListener("click",function(){var selectEl=document.getElementById("bulk-action-select");var action=selectEl?selectEl.value:"";if(!action){alert("Please select an action");return}var selectedQuestions=[];document.querySelectorAll(".question-checkbox:checked").forEach(function(checkbox){selectedQuestions.push(checkbox.dataset.questionId)});if(selectedQuestions.length===0){alert("Please select at least one question");return}var confirmMsg="Are you sure you want to "+action+" "+selectedQuestions.length+" question(s)?";if(!confirm(confirmMsg)){return}var form=document.createElement("form");form.method="POST";form.action=window.location.href;var sesskeyInput=document.createElement("input");sesskeyInput.type="hidden";sesskeyInput.name="sesskey";sesskeyInput.value=M.cfg.sesskey;form.appendChild(sesskeyInput);var actionInput=document.createElement("input");actionInput.type="hidden";actionInput.name="bulk_action";actionInput.value=action;form.appendChild(actionInput);selectedQuestions.forEach(function(qid){var qInput=document.createElement("input");qInput.type="hidden";qInput.name="question_ids[]";qInput.value=qid;form.appendChild(qInput)});document.body.appendChild(form);form.submit()})},_bindQuestionFilters:function(){var filterIds=["filter-status","filter-type","filter-difficulty"];var applyFilters=function(){var statusEl=document.getElementById("filter-status");var typeEl=document.getElementById("filter-type");var difficultyEl=document.getElementById("filter-difficulty");var statusFilter=statusEl?statusEl.value:"all";var typeFilter=typeEl?typeEl.value:"all";var difficultyFilter=difficultyEl?difficultyEl.value:"all";document.querySelectorAll(".question-card").forEach(function(card){var show=true;if(statusFilter!=="all"&&card.dataset.status!==statusFilter){show=false}if(typeFilter!=="all"&&card.dataset.type!==typeFilter){show=false}if(difficultyFilter!=="all"&&card.dataset.difficulty!==difficultyFilter){show=false}card.style.display=show?"":"none"});var selectAll=document.getElementById("select-all-questions");if(selectAll){selectAll.checked=false}};filterIds.forEach(function(id){var el=document.getElementById(id);if(el){el.addEventListener("change",applyFilters)}})},initStep5:function(){this._bindDeploymentTypeRadios();this._bindDeploymentFormSubmit()},_bindDeploymentTypeRadios:function(){document.querySelectorAll(".deploy-type-radio").forEach(function(radio){radio.addEventListener("change",function(){var newQuizOptions=document.getElementById("new_quiz_options");var qbankOptions=document.getElementById("qbank_options");var newQuizRadio=document.getElementById("deploy_new_quiz");var qbankRadio=document.getElementById("deploy_qbank");if(newQuizOptions){newQuizOptions.style.display=newQuizRadio&&newQuizRadio.checked?"block":"none"}if(qbankOptions){qbankOptions.style.display=qbankRadio&&qbankRadio.checked?"block":"none"}})})},_bindDeploymentFormSubmit:function(){var deploymentForm=document.getElementById("deployment-form");var isSubmitting=false;if(deploymentForm){deploymentForm.addEventListener("submit",function(e){if(isSubmitting){e.preventDefault();return false}isSubmitting=true;var submitBtn=deploymentForm.querySelector('button[type="submit"]');if(submitBtn){submitBtn.disabled=true;submitBtn.textContent="Deploying..."}})}}};return{init:function(config){$(document).ready(function(){Wizard.init(config)})}}});